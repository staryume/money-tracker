<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>üí∞ Money Tracker</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f0f1a; --card: #1a1a2e; --card2: #16213e;
    --accent-out: #ff6b9d; --accent-in: #6bcbff;
    --accent-out-dim: rgba(255,107,157,0.15); --accent-in-dim: rgba(107,203,255,0.15);
    --text: #f0e6ff; --text-dim: #8888aa; --border: rgba(255,255,255,0.08);
    --green: #7fff7f; --purple: #c084fc;
  }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header { background: linear-gradient(135deg,#1a1a2e,#16213e); border-bottom: 1px solid var(--border); padding: 14px 16px 10px; position: sticky; top: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .header-title { font-size: 17px; font-weight: 700; }
  .header-date { font-size: 11px; color: var(--text-dim); }
  .tab-bar { display: flex; gap: 6px; flex-shrink: 0; }
  .tab-btn { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); font-size: 12px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .tab-btn.active { background: var(--purple); color: white; border-color: var(--purple); }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  .content { max-width: 480px; margin: 0 auto; padding: 16px 14px 100px; }
  .page { display: none; } .page.active { display: block; }
  .section-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-dim); margin-bottom: 8px; margin-top: 16px; }

  /* ‚îÄ‚îÄ In/Out ‚îÄ‚îÄ */
  .inout-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 18px; }
  .inout-btn { padding: 16px; border-radius: 16px; border: 2px solid var(--border); background: var(--card); color: var(--text-dim); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; }
  .inout-btn:active { transform: scale(0.97); }
  .inout-btn.out.active { border-color: var(--accent-out); background: var(--accent-out-dim); color: var(--accent-out); }
  .inout-btn.in.active  { border-color: var(--accent-in);  background: var(--accent-in-dim);  color: var(--accent-in); }

  /* ‚îÄ‚îÄ Amount ‚îÄ‚îÄ */
  .amount-row { display: flex; gap: 10px; margin-bottom: 14px; align-items: stretch; }
  .amount-input { flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px 18px; font-size: 28px; font-weight: 700; color: var(--text); outline: none; transition: border-color 0.2s; }
  .amount-input:focus { border-color: var(--purple); }
  .yen-badge { display:flex; align-items:center; padding:0 16px; background:var(--card); border:1px solid var(--border); border-radius:14px; font-size:20px; font-weight:700; color:var(--purple); }

  /* ‚îÄ‚îÄ Chips ‚îÄ‚îÄ */
  .chip-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 4px; }
  .chip { padding: 10px 15px; border-radius: 24px; border: 1px solid var(--border); background: var(--card); color: var(--text-dim); font-size: 13px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .chip:active { transform: scale(0.95); }
  .chip.active { border-color: var(--purple); background: rgba(192,132,252,0.15); color: var(--purple); }
  .chip.active.out-mode { border-color: var(--accent-out); background: var(--accent-out-dim); color: var(--accent-out); }
  .chip.active.in-mode  { border-color: var(--accent-in);  background: var(--accent-in-dim);  color: var(--accent-in); }

  /* ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ */
  .text-input { width: 100%; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 13px 16px; font-size: 15px; color: var(--text); outline: none; transition: border-color 0.2s; margin-bottom: 4px; font-family: inherit; }
  .text-input:focus { border-color: var(--purple); }
  .text-input::placeholder { color: var(--text-dim); }
  .who-field { display: none; } .who-field.show { display: block; }

  /* ‚îÄ‚îÄ Date ‚îÄ‚îÄ */
  .date-row { display: flex; align-items: center; gap: 10px; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px 16px; }
  .date-label { font-size: 13px; color: var(--text-dim); flex: 1; }
  .date-input-styled { background: transparent; border: none; color: var(--text); font-size: 14px; font-weight: 600; font-family: inherit; outline: none; cursor: pointer; padding: 0; color-scheme: dark; }

  /* ‚îÄ‚îÄ Receipt ‚îÄ‚îÄ */
  .receipt-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .receipt-upload-btn { padding: 13px 10px; border-radius: 14px; border: 1.5px dashed var(--border); background: var(--card); color: var(--text-dim); font-size: 13px; cursor: pointer; transition: all 0.2s; text-align: center; line-height: 1.6; }
  .receipt-upload-btn:hover { border-color: var(--purple); color: var(--purple); }
  .receipt-preview-wrap { display: none; position: relative; margin-bottom: 4px; }
  .receipt-preview-wrap.show { display: block; }
  .receipt-preview { width: 100%; max-height: 180px; object-fit: cover; border-radius: 14px; border: 1px solid var(--border); cursor: pointer; }
  .receipt-remove-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; border-radius: 50%; background: rgba(0,0,0,0.7); border: none; color: white; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

  /* ‚îÄ‚îÄ Save ‚îÄ‚îÄ */
  .save-btn { width: 100%; padding: 17px; border-radius: 18px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; margin-top: 22px; background: linear-gradient(135deg,#c084fc,#ff6b9d); color: white; letter-spacing: 0.5px; }
  .save-btn:active { transform: scale(0.97); opacity: 0.9; }

  /* ‚îÄ‚îÄ Sync status ‚îÄ‚îÄ */
  .sync-bar { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 10px; background: var(--card); border: 1px solid var(--border); margin-bottom: 14px; font-size: 12px; color: var(--text-dim); }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #888; flex-shrink: 0; }
  .sync-dot.ok { background: var(--green); }
  .sync-dot.error { background: var(--accent-out); }
  .sync-dot.loading { background: #ffcc44; animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .setup-link { color: var(--purple); text-decoration: underline; cursor: pointer; margin-left: auto; font-size: 11px; }

  /* ‚îÄ‚îÄ Log entries ‚îÄ‚îÄ */
  .entry-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 13px 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
  .entry-icon { width: 38px; height: 38px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 17px; flex-shrink: 0; }
  .entry-icon.out { background: var(--accent-out-dim); }
  .entry-icon.in  { background: var(--accent-in-dim); }
  .entry-info { flex: 1; min-width: 0; }
  .entry-desc { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .entry-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .entry-receipt-thumb { width: 34px; height: 34px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border); cursor: pointer; flex-shrink: 0; }
  .entry-delete-btn { width: 28px; height: 28px; border-radius: 8px; border: none; background: transparent; color: var(--text-dim); font-size: 15px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .entry-delete-btn:hover { background: rgba(255,107,157,0.15); color: var(--accent-out); }
  /* Confirm delete state */
  .entry-card.confirming { border-color: var(--accent-out); background: rgba(255,107,157,0.07); }
  .confirm-row { display: flex; gap: 6px; align-items: center; margin-top: 8px; }
  .confirm-yes { padding: 5px 12px; border-radius: 8px; border: none; background: var(--accent-out); color: white; font-size: 12px; font-weight: 700; cursor: pointer; }
  .confirm-no  { padding: 5px 12px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); font-size: 12px; cursor: pointer; }
  .entry-amount { font-size: 15px; font-weight: 700; text-align: right; flex-shrink: 0; }
  .entry-amount.out { color: var(--accent-out); }
  .entry-amount.in  { color: var(--accent-in); }
  .load-more-btn { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); color: var(--text-dim); font-size: 13px; cursor: pointer; margin-top: 4px; }

  /* ‚îÄ‚îÄ Summary ‚îÄ‚îÄ */
  .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
  .summary-card-label { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
  .summary-card-value { font-size: 22px; font-weight: 700; }
  .summary-card-value.out { color: var(--accent-out); }
  .summary-card-value.in  { color: var(--accent-in); }
  .summary-card-value.net.pos { color: var(--green); }
  .summary-card-value.net.neg { color: var(--accent-out); }
  .month-picker { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
  .month-nav { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .month-label { flex: 1; text-align: center; font-weight: 700; font-size: 15px; }
  .bar-chart { margin-bottom: 16px; }
  .bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
  .bar-row-label { font-size: 12px; color: var(--text-dim); width: 90px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .bar-track { flex: 1; height: 20px; background: var(--card); border-radius: 6px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 6px; transition: width 0.4s ease; }
  .bar-fill.out { background: var(--accent-out); }
  .bar-fill.in  { background: var(--accent-in); }
  .bar-val { font-size: 12px; font-weight: 600; width: 70px; text-align: right; flex-shrink: 0; }
  .pdf-btn { width: 100%; padding: 14px; border-radius: 14px; border: 1px solid var(--purple); background: rgba(192,132,252,0.1); color: var(--purple); font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px; }
  .pdf-btn:active { transform: scale(0.97); }

  /* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
  .img-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.93); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
  .img-modal.show { display: flex; }
  .img-modal img { max-width: 100%; max-height: 90vh; border-radius: 12px; object-fit: contain; }
  .modal-close { position: fixed; top: 18px; right: 18px; width: 38px; height: 38px; border-radius: 50%; background: rgba(255,255,255,0.15); border: none; color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .setup-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 300; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; }
  .setup-modal.show { display: flex; }
  .setup-box { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 24px; max-width: 460px; width: 100%; margin-top: 20px; }
  .setup-box h2 { font-size: 18px; margin-bottom: 4px; }
  .setup-box p { font-size: 13px; color: var(--text-dim); margin-bottom: 14px; }
  .setup-box input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px; font-size: 14px; color: var(--text); outline: none; margin-bottom: 10px; font-family: monospace; }
  .setup-box input:focus { border-color: var(--purple); }
  .setup-save-btn { width: 100%; padding: 14px; border-radius: 14px; border: none; background: var(--purple); color: white; font-size: 15px; font-weight: 700; cursor: pointer; margin-top: 4px; }

  /* ‚îÄ‚îÄ Empty / Toast ‚îÄ‚îÄ */
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); }
  .empty-state .emoji { font-size: 36px; margin-bottom: 10px; }
  .toast { position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--green); color: #000; padding: 11px 22px; border-radius: 24px; font-weight: 700; font-size: 13px; transition: transform 0.3s ease; z-index: 100; white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }

  @media print {
    .header, .tab-bar, .tab-btn, .pdf-btn, .month-nav { display: none !important; }
    body { background: white; color: black; }
    .summary-card { border: 1px solid #ddd; }
  }
</style>
</head>
<body>

<div class="header">
  <div>
    <div class="header-title">üí∞ Money Tracker</div>
    <div class="header-date" id="headerDate"></div>
  </div>
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('add')">Ôºã Add</button>
    <button class="tab-btn" onclick="switchTab('log')">üìã Log</button>
    <button class="tab-btn" onclick="switchTab('summary')">üìä Summary</button>
  </div>
</div>

<div class="content">

  <!-- ‚ïê‚ïê ADD ‚ïê‚ïê -->
  <div class="page active" id="page-add">

    <!-- Sync status bar -->
    <div class="sync-bar">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncStatus">Not connected to Google Sheets</span>
      <span class="setup-link" onclick="openSetup()">‚öô Setup</span>
    </div>

    <!-- In / Out -->
    <div class="inout-toggle">
      <button class="inout-btn out" id="btn-out" onclick="setDirection('out')">üí∏ Spent</button>
      <button class="inout-btn in"  id="btn-in"  onclick="setDirection('in')">üí∞ Received</button>
    </div>

    <!-- Amount -->
    <div class="amount-row">
      <input class="amount-input" id="amountInput" type="number" inputmode="decimal" placeholder="0" min="0">
      <div class="yen-badge">¬•</div>
    </div>

    <!-- Method -->
    <div class="section-label">Method</div>
    <div class="chip-grid" id="method-chips"></div>

    <!-- Situation -->
    <div class="section-label">Situation</div>
    <div class="chip-grid" id="situation-chips"></div>

    <!-- Who -->
    <div class="who-field" id="whoField">
      <div class="section-label">With who?</div>
      <input class="text-input" id="whoInput" type="text" placeholder="Name‚Ä¶">
    </div>

    <!-- Description -->
    <div class="section-label">Description <span style="opacity:0.4">(optional)</span></div>
    <input class="text-input" id="descInput" type="text" placeholder="e.g. lunch ramen, Starbucks‚Ä¶" maxlength="60">

    <!-- Receipt -->
    <div id="receiptSection">
      <div class="section-label">Receipt photo <span style="opacity:0.4">(optional)</span></div>
      <div class="receipt-btns">
        <label class="receipt-upload-btn" for="receiptCamera">
          üì∑<br>Take Photo
          <input type="file" id="receiptCamera" accept="image/*" capture="environment" style="display:none" onchange="handleReceiptFile(this)">
        </label>
        <label class="receipt-upload-btn" for="receiptGallery">
          üñºÔ∏è<br>Choose Image
          <input type="file" id="receiptGallery" accept="image/*" style="display:none" onchange="handleReceiptFile(this)">
        </label>
      </div>
      <div class="receipt-preview-wrap" id="receiptPreviewWrap">
        <img class="receipt-preview" id="receiptPreviewImg" src="" alt="receipt" onclick="openImgModal(this.src)">
        <button class="receipt-remove-btn" onclick="removeReceipt()">‚úï</button>
      </div>
    </div>

    <!-- Date -->
    <div class="section-label">Date</div>
    <div class="date-row">
      <span class="date-label">üìÖ</span>
      <input class="date-input-styled" type="date" id="dateInput" onchange="updateDate()">
    </div>

    <button class="save-btn" onclick="saveEntry()">‚úì Save</button>
  </div>

  <!-- ‚ïê‚ïê LOG ‚ïê‚ïê -->
  <div class="page" id="page-log">
    <div class="section-label" style="margin-top:0">Recent Entries</div>
    <div id="entriesList"></div>
  </div>

  <!-- ‚ïê‚ïê SUMMARY ‚ïê‚ïê -->
  <div class="page" id="page-summary">
    <div class="month-picker">
      <button class="month-nav" onclick="changeMonth(-1)">‚Äπ</button>
      <div class="month-label" id="summaryMonthLabel"></div>
      <button class="month-nav" onclick="changeMonth(1)">‚Ä∫</button>
    </div>

    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-card-label">üí∏ Total Spent</div>
        <div class="summary-card-value out" id="sumSpent">¬•0</div>
      </div>
      <div class="summary-card">
        <div class="summary-card-label">üí∞ Total Received</div>
        <div class="summary-card-value in" id="sumReceived">¬•0</div>
      </div>
      <div class="summary-card" style="grid-column:span 2">
        <div class="summary-card-label">üìà Net Balance</div>
        <div class="summary-card-value net" id="sumNet">¬•0</div>
      </div>
    </div>

    <div class="section-label">Spending by Situation</div>
    <div class="bar-chart" id="situationChart"></div>

    <div class="section-label">Spending by Method</div>
    <div class="bar-chart" id="methodChart"></div>

    <button class="pdf-btn" onclick="printSummary()">üñ® Print / Save as PDF</button>
  </div>

</div>

<!-- Image modal -->
<div class="img-modal" id="imgModal" onclick="closeImgModal()">
  <button class="modal-close">‚úï</button>
  <img id="imgModalSrc" src="" alt="receipt">
</div>

<!-- Setup modal -->
<div class="setup-modal" id="setupModal">
  <div class="setup-box">
    <h2>‚öôÔ∏è Connect Google Sheets</h2>
    <p>Paste your Google Apps Script Web App URL below to sync data to your spreadsheet.</p>
    <input type="url" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/‚Ä¶/exec">
    <p style="margin-top:8px">Don't have one yet? Open the <strong>SETUP GUIDE</strong> file for step-by-step instructions.</p>
    <button class="setup-save-btn" onclick="saveScriptUrl()">Save & Connect</button>
    <button style="width:100%;margin-top:8px;padding:12px;border-radius:14px;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-size:13px" onclick="closeSetup()">Cancel</button>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê State ‚ïê‚ïê
let state = { direction: null, method: null, situation: null, receiptImage: null, date: todayStr() };
let entries = JSON.parse(localStorage.getItem('mt_entries') || '[]');
let scriptUrl = localStorage.getItem('mt_scriptUrl') || '';
let summaryMonth = new Date();

// ‚ïê‚ïê Config ‚ïê‚ïê
const METHODS_OUT = ['üíµ Cash','üì± PayPay','üöÉ PASMO','üí≥ Credit Card','‚ùì Other'];
const METHODS_IN  = ['üíµ Cash','üì± PayPay','üöÉ PASMO','üè¶ Bank Transfer','‚ùì Other'];
const SITUATIONS_OUT = ['üõí Real world','üì± App/Game','üåê Online shop','ü§ù Lend to friend','‚ùì Other'];
const SITUATIONS_IN  = ['ü§ù Got money back','üíº Income','üéÅ Tip / Bonus','üì• Borrowed from someone','‚ùì Other'];

// ‚ïê‚ïê Init ‚ïê‚ïê
function init() {
  document.getElementById('headerDate').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  document.getElementById('dateInput').value = todayStr();
  setDirection('out');
  updateSyncStatus();
  renderEntries();
  renderSummary();
}

// ‚ïê‚ïê Direction ‚ïê‚ïê
function setDirection(dir) {
  state.direction = dir; state.method = null; state.situation = null;
  document.getElementById('btn-out').classList.toggle('active', dir==='out');
  document.getElementById('btn-in').classList.toggle('active',  dir==='in');
  renderChips('method-chips',   dir==='out' ? METHODS_OUT    : METHODS_IN,    'method');
  renderChips('situation-chips',dir==='out' ? SITUATIONS_OUT : SITUATIONS_IN, 'situation');
  updateWhoField();
  document.getElementById('receiptSection').style.display = dir==='out' ? 'block' : 'none';
}

// ‚ïê‚ïê Chips ‚ïê‚ïê
function renderChips(containerId, items, key) {
  document.getElementById(containerId).innerHTML = items.map(item => {
    const active = state[key] === item;
    return `<button class="chip${active ? ' active '+state.direction+'-mode' : ''}" onclick="selectChip('${key}','${item}')">${item}</button>`;
  }).join('');
}
function selectChip(key, val) {
  state[key] = val;
  if (key==='method')    renderChips('method-chips',    state.direction==='out'?METHODS_OUT:METHODS_IN,       'method');
  if (key==='situation') { renderChips('situation-chips',state.direction==='out'?SITUATIONS_OUT:SITUATIONS_IN,'situation'); updateWhoField(); }
}
function updateWhoField() {
  const show = state.situation && ['Lend to friend','Got money back','Borrowed from someone'].some(s => state.situation.includes(s));
  document.getElementById('whoField').classList.toggle('show', show);
}

// ‚ïê‚ïê Receipt ‚ïê‚ïê
function handleReceiptFile(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => compressImage(e.target.result, 900, 0.72, compressed => {
    state.receiptImage = compressed;
    document.getElementById('receiptPreviewImg').src = compressed;
    document.getElementById('receiptPreviewWrap').classList.add('show');
  });
  reader.readAsDataURL(file); input.value='';
}
function compressImage(dataUrl, maxPx, quality, cb) {
  const img = new Image();
  img.onload = () => {
    const c = document.createElement('canvas');
    let w=img.width, h=img.height;
    if (w>maxPx||h>maxPx) { if(w>h){h=Math.round(h*maxPx/w);w=maxPx;}else{w=Math.round(w*maxPx/h);h=maxPx;} }
    c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
    cb(c.toDataURL('image/jpeg',quality));
  };
  img.src=dataUrl;
}
function removeReceipt() {
  state.receiptImage=null;
  document.getElementById('receiptPreviewImg').src='';
  document.getElementById('receiptPreviewWrap').classList.remove('show');
}

// ‚ïê‚ïê Date ‚ïê‚ïê
function todayStr() { return new Date().toISOString().split('T')[0]; }
function updateDate() { state.date = document.getElementById('dateInput').value; }

// ‚ïê‚ïê Save ‚ïê‚ïê
async function saveEntry() {
  const amount = parseFloat(document.getElementById('amountInput').value);
  if (!amount||amount<=0) { showToast('Enter an amount ‚ö†Ô∏è','#ffcc44'); return; }
  if (!state.method)    { showToast('Pick a method ‚ö†Ô∏è','#ffcc44'); return; }
  if (!state.situation) { showToast('Pick a situation ‚ö†Ô∏è','#ffcc44'); return; }

  const entry = {
    id: Date.now(), direction: state.direction, amount, currency:'JPY',
    method: state.method, situation: state.situation,
    desc: document.getElementById('descInput').value.trim(),
    receiptImage: state.receiptImage,
    who: document.getElementById('whoInput').value.trim(),
    date: state.date, savedAt: new Date().toISOString()
  };

  // Save locally first
  entries.unshift(entry);
  localStorage.setItem('mt_entries', JSON.stringify(entries));

  // Sync to Google Sheets if configured
  if (scriptUrl) {
    setSyncStatus('loading','Syncing‚Ä¶');
    try {
      const payload = { ...entry }; delete payload.receiptImage; // images not sent to Sheets
      await fetch(scriptUrl, { method:'POST', body: JSON.stringify(payload), mode:'no-cors' });
      setSyncStatus('ok','Synced to Google Sheets ‚úì');
    } catch(e) {
      setSyncStatus('error','Sync failed ‚Äî saved locally');
    }
  }

  // Reset form
  document.getElementById('amountInput').value = '';
  document.getElementById('descInput').value = '';
  document.getElementById('whoInput').value = '';
  state.method=null; state.situation=null; state.receiptImage=null;
  document.getElementById('receiptPreviewImg').src='';
  document.getElementById('receiptPreviewWrap').classList.remove('show');
  renderChips('method-chips',   state.direction==='out'?METHODS_OUT:METHODS_IN,       'method');
  renderChips('situation-chips',state.direction==='out'?SITUATIONS_OUT:SITUATIONS_IN, 'situation');
  updateWhoField();

  showToast('Saved! üå∏','#7fff7f');
  setTimeout(()=>switchTab('log'), 700);
}

// ‚ïê‚ïê Log ‚ïê‚ïê
function renderEntries() {
  const list = document.getElementById('entriesList');
  if (!entries.length) {
    list.innerHTML=`<div class="empty-state"><div class="emoji">üå∏</div><p>No entries yet.</p></div>`; return;
  }
  list.innerHTML = entries.slice(0,40).map(e => {
    const icon  = e.direction==='out'?'üí∏':'üí∞';
    const sign  = e.direction==='out'?'-':'+';
    const label = e.desc || e.situation.replace(/^\S+\s/,'');
    const d     = new Date(e.date+'T00:00:00');
    const dateStr = d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const method  = e.method.replace(/^\S+\s/,'');
    const thumb   = e.receiptImage
      ? `<img class="entry-receipt-thumb" src="${e.receiptImage}" onclick="openImgModal('${e.receiptImage}')" title="View receipt">`
      : '';
    return `<div class="entry-card" id="card-${e.id}">
      <div class="entry-icon ${e.direction}">${icon}</div>
      <div class="entry-info">
        <div class="entry-desc">${label}</div>
        <div class="entry-meta">${method} ¬∑ ${dateStr}${e.who?' ¬∑ '+e.who:''}</div>
        <div class="confirm-row" id="confirm-${e.id}" style="display:none">
          <span style="font-size:12px;color:var(--accent-out)">Delete this entry?</span>
          <button class="confirm-yes" onclick="confirmDelete(${e.id})">Yes, delete</button>
          <button class="confirm-no"  onclick="cancelDelete(${e.id})">Cancel</button>
        </div>
      </div>
      ${thumb}
      <div class="entry-amount ${e.direction}">${sign}¬•${Number(e.amount).toLocaleString()}</div>
      <button class="entry-delete-btn" onclick="askDelete(${e.id})" title="Delete entry">üóë</button>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê Delete ‚ïê‚ïê
function askDelete(id) {
  // Hide any other open confirm rows first
  document.querySelectorAll('.confirm-row').forEach(r => r.style.display='none');
  document.querySelectorAll('.entry-card').forEach(c => c.classList.remove('confirming'));
  // Show this one
  document.getElementById('confirm-'+id).style.display='flex';
  document.getElementById('card-'+id).classList.add('confirming');
}
function cancelDelete(id) {
  document.getElementById('confirm-'+id).style.display='none';
  document.getElementById('card-'+id).classList.remove('confirming');
}
function confirmDelete(id) {
  entries = entries.filter(e => e.id !== id);
  localStorage.setItem('mt_entries', JSON.stringify(entries));
  renderEntries();
  showToast('Entry deleted','#ffcc44');
}

// ‚ïê‚ïê Summary ‚ïê‚ïê
function renderSummary() {
  const y = summaryMonth.getFullYear();
  const m = summaryMonth.getMonth();
  document.getElementById('summaryMonthLabel').textContent =
    summaryMonth.toLocaleDateString('en-US',{month:'long',year:'numeric'});

  const monthEntries = entries.filter(e => {
    const d = new Date(e.date+'T00:00:00');
    return d.getFullYear()===y && d.getMonth()===m;
  });

  const spent    = monthEntries.filter(e=>e.direction==='out').reduce((s,e)=>s+e.amount,0);
  const received = monthEntries.filter(e=>e.direction==='in' ).reduce((s,e)=>s+e.amount,0);
  const net      = received - spent;

  document.getElementById('sumSpent').textContent    = '¬•'+spent.toLocaleString();
  document.getElementById('sumReceived').textContent = '¬•'+received.toLocaleString();
  const netEl = document.getElementById('sumNet');
  netEl.textContent = (net>=0?'+':'')+'¬•'+net.toLocaleString();
  netEl.className = 'summary-card-value net '+(net>=0?'pos':'neg');

  // Situation breakdown (out only)
  const sitMap = {};
  monthEntries.filter(e=>e.direction==='out').forEach(e=>{
    const k = e.situation.replace(/^\S+\s/,'');
    sitMap[k] = (sitMap[k]||0)+e.amount;
  });
  renderBarChart('situationChart', sitMap, spent, 'out');

  // Method breakdown (out only)
  const methMap = {};
  monthEntries.filter(e=>e.direction==='out').forEach(e=>{
    const k = e.method.replace(/^\S+\s/,'');
    methMap[k] = (methMap[k]||0)+e.amount;
  });
  renderBarChart('methodChart', methMap, spent, 'out');
}

function renderBarChart(id, map, total, dir) {
  const el = document.getElementById(id);
  const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]);
  if (!sorted.length) { el.innerHTML='<div style="color:var(--text-dim);font-size:13px;padding:8px 0">No data</div>'; return; }
  el.innerHTML = sorted.map(([label,val])=>{
    const pct = total>0 ? (val/total*100).toFixed(0) : 0;
    return `<div class="bar-row">
      <div class="bar-row-label">${label}</div>
      <div class="bar-track"><div class="bar-fill ${dir}" style="width:${pct}%"></div></div>
      <div class="bar-val">¬•${val.toLocaleString()}</div>
    </div>`;
  }).join('');
}

function changeMonth(delta) {
  summaryMonth = new Date(summaryMonth.getFullYear(), summaryMonth.getMonth()+delta, 1);
  renderSummary();
}

function printSummary() {
  switchTab('summary');
  setTimeout(()=>window.print(), 200);
}

// ‚ïê‚ïê Sync / Setup ‚ïê‚ïê
function updateSyncStatus() {
  if (scriptUrl) setSyncStatus('ok','Connected to Google Sheets');
  else setSyncStatus('', 'Not connected ‚Äî data saved locally');
}
function setSyncStatus(type, msg) {
  const dot = document.getElementById('syncDot');
  const txt = document.getElementById('syncStatus');
  dot.className = 'sync-dot' + (type?' '+type:'');
  txt.textContent = msg;
}
function openSetup()  {
  document.getElementById('scriptUrlInput').value = scriptUrl;
  document.getElementById('setupModal').classList.add('show');
}
function closeSetup() { document.getElementById('setupModal').classList.remove('show'); }
function saveScriptUrl() {
  const url = document.getElementById('scriptUrlInput').value.trim();
  scriptUrl = url;
  localStorage.setItem('mt_scriptUrl', url);
  closeSetup();
  updateSyncStatus();
  showToast(url ? 'Connected! üå∏' : 'Disconnected','#7fff7f');
}

// ‚ïê‚ïê Image modal ‚ïê‚ïê
function openImgModal(src) { document.getElementById('imgModalSrc').src=src; document.getElementById('imgModal').classList.add('show'); }
function closeImgModal()   { document.getElementById('imgModal').classList.remove('show'); }

// ‚ïê‚ïê Toast ‚ïê‚ïê
function showToast(msg, color='#7fff7f') {
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.background=color;
  t.style.color=color==='#ffcc44'?'#333':'#000';
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200);
}

// ‚ïê‚ïê Tab ‚ïê‚ïê
function switchTab(tab) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+tab).classList.add('active');
  const idx = {add:0,log:1,summary:2}[tab];
  document.querySelectorAll('.tab-btn')[idx].classList.add('active');
  if (tab==='log')     renderEntries();
  if (tab==='summary') renderSummary();
}

init();
</script>
</body>
</html>
