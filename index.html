<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ’° Money Tracker</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f0f1a; --card: #1a1a2e; --card2: #16213e;
    --accent-out: #ff6b9d; --accent-in: #6bcbff;
    --accent-out-dim: rgba(255,107,157,0.15); --accent-in-dim: rgba(107,203,255,0.15);
    --text: #f0e6ff; --text-dim: #8888aa; --border: rgba(255,255,255,0.08);
    --green: #7fff7f; --purple: #c084fc;
    --tab-h: 58px;
  }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
         background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PIN LOCK SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .pin-screen {
    position: fixed; inset: 0; z-index: 999;
    background: var(--bg);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 30px 24px;
    transition: opacity 0.35s ease;
  }
  .pin-screen.hidden { opacity: 0; pointer-events: none; }

  .pin-logo  { font-size: 44px; margin-bottom: 12px; }
  .pin-title { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
  .pin-sub   { font-size: 13px; color: var(--text-dim); margin-bottom: 32px; text-align: center; max-width: 260px; line-height: 1.5; }

  /* Dot display */
  .pin-dots  { display: flex; gap: 14px; margin-bottom: 32px; }
  .pin-dot   { width: 16px; height: 16px; border-radius: 50%;
               border: 2px solid var(--border); background: transparent;
               transition: background 0.15s, border-color 0.15s; }
  .pin-dot.filled { background: var(--purple); border-color: var(--purple); }
  .pin-dot.error  { background: var(--accent-out); border-color: var(--accent-out); }

  /* Error msg */
  .pin-error { font-size: 13px; color: var(--accent-out); min-height: 18px;
               margin-bottom: 16px; text-align: center; }

  /* Keypad */
  .pin-keypad { display: grid; grid-template-columns: repeat(3, 72px); gap: 14px; }
  .pin-key {
    width: 72px; height: 72px; border-radius: 50%;
    border: 1px solid var(--border); background: var(--card);
    color: var(--text); font-size: 22px; font-weight: 600;
    cursor: pointer; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 1px;
    transition: background 0.12s, transform 0.1s;
    -webkit-tap-highlight-color: transparent; user-select: none;
  }
  .pin-key:active { background: rgba(192,132,252,0.25); transform: scale(0.92); }
  .pin-key.empty  { background: transparent; border-color: transparent; cursor: default; }
  .pin-key.del    { font-size: 20px; }
  .pin-key-sub    { font-size: 9px; color: var(--text-dim); letter-spacing: 0.5px; }

  /* Shake animation for wrong PIN */
  @keyframes shake {
    0%,100%{transform:translateX(0)}
    20%{transform:translateX(-8px)}
    40%{transform:translateX(8px)}
    60%{transform:translateX(-6px)}
    80%{transform:translateX(6px)}
  }
  .shake { animation: shake 0.4s ease; }

  /* Confirm step label */
  .pin-step { display: inline-block; padding: 4px 12px; border-radius: 20px;
              background: rgba(192,132,252,0.12); border: 1px solid rgba(192,132,252,0.25);
              font-size: 11px; color: var(--purple); margin-bottom: 24px; }

  /* Change PIN link */
  .pin-change-link { margin-top: 24px; font-size: 12px; color: var(--text-dim);
                     text-decoration: underline; cursor: pointer; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP (hidden until unlocked)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .app-wrap { display: none; }
  .app-wrap.visible { display: block; }

  /* â”€â”€ Header â”€â”€ */
  .header { background: linear-gradient(135deg,#1a1a2e,#16213e); border-bottom: 1px solid var(--border);
            padding: 12px 16px 10px; position: sticky; top: 0; z-index: 10;
            display: flex; align-items: center; justify-content: space-between; }
  .header-title { font-size: 17px; font-weight: 700; }
  .header-date  { font-size: 11px; color: var(--text-dim); margin-top: 1px; }
  .setup-btn    { padding: 7px 12px; border-radius: 10px; border: 1px solid var(--border);
                  background: transparent; color: var(--text-dim); font-size: 13px; cursor: pointer;
                  -webkit-tap-highlight-color: transparent; }
  .setup-btn:active { background: var(--card2); }

  /* â”€â”€ Bottom tab bar â”€â”€ */
  .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; display: flex;
             background: var(--card); border-top: 1px solid var(--border); z-index: 20;
             padding-bottom: env(safe-area-inset-bottom, 0); }
  .tab-btn { flex: 1; padding: 9px 4px 7px; border: none; background: transparent;
             color: var(--text-dim); font-size: 10px; cursor: pointer;
             display: flex; flex-direction: column; align-items: center; gap: 2px;
             transition: color 0.15s; -webkit-tap-highlight-color: transparent; }
  .tab-btn.active { color: var(--purple); }
  .tab-icon { font-size: 22px; line-height: 1; }

  /* â”€â”€ Layout â”€â”€ */
  .content { max-width: 480px; margin: 0 auto; padding: 14px 14px;
             padding-bottom: calc(var(--tab-h) + env(safe-area-inset-bottom, 0px) + 20px); }
  .page { display: none; } .page.active { display: block; }
  .section-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px;
                   color: var(--text-dim); margin-bottom: 8px; margin-top: 16px; }

  /* â”€â”€ Sync bar â”€â”€ */
  .sync-bar { display: flex; align-items: center; gap: 8px; padding: 8px 12px;
              border-radius: 10px; background: var(--card); border: 1px solid var(--border);
              margin-bottom: 14px; font-size: 12px; color: var(--text-dim); }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; flex-shrink: 0; }
  .sync-dot.ok      { background: var(--green); }
  .sync-dot.error   { background: var(--accent-out); }
  .sync-dot.loading { background: #ffcc44; animation: pulse 0.9s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.35} }

  /* â”€â”€ In/Out â”€â”€ */
  .inout-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .inout-btn { padding: 14px; border-radius: 16px; border: 2px solid var(--border);
               background: var(--card); color: var(--text-dim); font-size: 15px;
               font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center;
               -webkit-tap-highlight-color: transparent; }
  .inout-btn:active { transform: scale(0.97); }
  .inout-btn.out.active { border-color: var(--accent-out); background: var(--accent-out-dim); color: var(--accent-out); }
  .inout-btn.in.active  { border-color: var(--accent-in);  background: var(--accent-in-dim);  color: var(--accent-in); }

  /* â”€â”€ Amount â”€â”€ */
  .amount-row { display: flex; gap: 10px; margin-bottom: 14px; align-items: stretch; }
  .amount-input { flex: 1; min-width: 0; background: var(--card); border: 1px solid var(--border);
                  border-radius: 14px; padding: 13px 16px; font-size: 26px; font-weight: 700;
                  color: var(--text); outline: none; transition: border-color 0.2s; }
  .amount-input:focus { border-color: var(--purple); }
  .yen-badge { display:flex; align-items:center; padding:0 14px; background:var(--card);
               border:1px solid var(--border); border-radius:14px; font-size:20px;
               font-weight:700; color:var(--purple); flex-shrink:0; }

  /* â”€â”€ Chips â”€â”€ */
  .chip-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 4px; }
  .chip { padding: 9px 13px; border-radius: 24px; border: 1px solid var(--border);
          background: var(--card); color: var(--text-dim); font-size: 13px;
          cursor: pointer; transition: all 0.15s; white-space: nowrap;
          -webkit-tap-highlight-color: transparent; }
  .chip:active { transform: scale(0.95); }
  .chip.active           { border-color: var(--purple);     background: rgba(192,132,252,0.15); color: var(--purple); }
  .chip.active.out-mode  { border-color: var(--accent-out); background: var(--accent-out-dim); color: var(--accent-out); }
  .chip.active.in-mode   { border-color: var(--accent-in);  background: var(--accent-in-dim);  color: var(--accent-in); }

  /* â”€â”€ Text inputs â”€â”€ */
  .text-input { width: 100%; background: var(--card); border: 1px solid var(--border);
                border-radius: 14px; padding: 13px 16px; font-size: 15px; color: var(--text);
                outline: none; transition: border-color 0.2s; margin-bottom: 4px; font-family: inherit; }
  .text-input:focus { border-color: var(--purple); }
  .text-input::placeholder { color: var(--text-dim); }
  .who-field  { display: none; } .who-field.show  { display: block; }
  .card-field { display: none; } .card-field.show { display: block; }

  /* â”€â”€ Date â”€â”€ */
  .date-row { display: flex; align-items: center; gap: 10px; background: var(--card);
              border: 1px solid var(--border); border-radius: 14px; padding: 12px 16px; }
  .date-label { font-size: 13px; color: var(--text-dim); flex: 1; }
  .date-input-styled { background: transparent; border: none; color: var(--text);
                       font-size: 14px; font-weight: 600; font-family: inherit;
                       outline: none; cursor: pointer; padding: 0; color-scheme: dark; }

  /* â”€â”€ Receipt â”€â”€ */
  .receipt-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .receipt-upload-btn { padding: 13px 10px; border-radius: 14px; border: 1.5px dashed var(--border);
                        background: var(--card); color: var(--text-dim); font-size: 13px;
                        cursor: pointer; transition: all 0.2s; text-align: center;
                        line-height: 1.6; display: block; }
  .receipt-upload-btn:active { border-color: var(--purple); color: var(--purple); }
  .receipt-preview-wrap { display: none; position: relative; margin-bottom: 4px; }
  .receipt-preview-wrap.show { display: block; }
  .receipt-preview { width: 100%; max-height: 180px; object-fit: cover; border-radius: 14px;
                     border: 1px solid var(--border); cursor: pointer; display: block; }
  .receipt-remove-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px;
                        border-radius: 50%; background: rgba(0,0,0,0.75); border: none;
                        color: white; font-size: 14px; cursor: pointer;
                        display: flex; align-items: center; justify-content: center; }

  /* â”€â”€ Save â”€â”€ */
  .save-btn { width: 100%; padding: 17px; border-radius: 18px; border: none; font-size: 16px;
              font-weight: 700; cursor: pointer; transition: all 0.2s; margin-top: 20px;
              background: linear-gradient(135deg,#c084fc,#ff6b9d); color: white;
              letter-spacing: 0.5px; -webkit-tap-highlight-color: transparent; }
  .save-btn:active { transform: scale(0.97); opacity: 0.9; }

  /* â”€â”€ Log header â”€â”€ */
  .log-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .log-header-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-dim); }
  .refresh-btn { display: flex; align-items: center; gap: 5px; padding: 6px 11px;
                 border-radius: 10px; border: 1px solid var(--border); background: transparent;
                 color: var(--text-dim); font-size: 12px; cursor: pointer;
                 -webkit-tap-highlight-color: transparent; }
  .refresh-btn:active { background: var(--card); }
  .refresh-btn.loading { color: var(--purple); border-color: var(--purple); }
  .spin { display: inline-block; animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Log entries â”€â”€ */
  .entry-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px;
                padding: 12px 12px; margin-bottom: 10px; display: flex; align-items: center;
                gap: 9px; animation: slideIn 0.25s ease; }
  @keyframes slideIn { from{opacity:0;transform:translateY(-5px)} to{opacity:1;transform:translateY(0)} }
  .entry-icon { width: 36px; height: 36px; border-radius: 10px; display: flex;
                align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
  .entry-icon.out { background: var(--accent-out-dim); }
  .entry-icon.in  { background: var(--accent-in-dim); }
  .entry-info { flex: 1; min-width: 0; }
  .entry-desc { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .entry-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .entry-receipt-thumb { width: 32px; height: 32px; border-radius: 8px; object-fit: cover;
                         border: 1px solid var(--border); cursor: pointer; flex-shrink: 0; }
  .entry-receipt-link  { width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border);
                         background: var(--card2); display: flex; align-items: center;
                         justify-content: center; text-decoration: none; font-size: 15px; flex-shrink: 0; }
  .entry-amount { font-size: 14px; font-weight: 700; text-align: right; flex-shrink: 0; }
  .entry-amount.out { color: var(--accent-out); }
  .entry-amount.in  { color: var(--accent-in); }
  .entry-delete-btn { width: 26px; height: 26px; border-radius: 8px; border: none;
                      background: transparent; color: var(--text-dim); font-size: 14px;
                      cursor: pointer; flex-shrink: 0; display: flex; align-items: center;
                      justify-content: center; transition: all 0.2s; }
  .entry-delete-btn:active { background: rgba(255,107,157,0.15); color: var(--accent-out); }
  .entry-card.confirming { border-color: var(--accent-out); background: rgba(255,107,157,0.07); }
  .confirm-row { display: flex; gap: 6px; align-items: center; margin-top: 8px; }
  .confirm-yes { padding: 5px 11px; border-radius: 8px; border: none; background: var(--accent-out);
                 color: white; font-size: 12px; font-weight: 700; cursor: pointer; }
  .confirm-no  { padding: 5px 11px; border-radius: 8px; border: 1px solid var(--border);
                 background: transparent; color: var(--text-dim); font-size: 12px; cursor: pointer; }

  /* â”€â”€ Edit button â”€â”€ */
  .entry-edit-btn { width: 26px; height: 26px; border-radius: 8px; border: none;
                    background: transparent; color: var(--text-dim); font-size: 13px;
                    cursor: pointer; flex-shrink: 0; display: flex; align-items: center;
                    justify-content: center; transition: all 0.2s; }
  .entry-edit-btn:active { background: rgba(192,132,252,0.15); color: var(--purple); }

  /* â”€â”€ Edit modal (bottom sheet) â”€â”€ */
  .edit-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
                z-index: 150; align-items: flex-end; }
  .edit-modal.show { display: flex; }
  .edit-sheet { background: var(--bg); width: 100%; max-height: 92vh;
                border-radius: 22px 22px 0 0; overflow-y: auto;
                padding: 0 16px calc(env(safe-area-inset-bottom,0px) + 24px);
                animation: slideUp 0.28s ease; }
  @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
  .edit-header { display: flex; align-items: center; justify-content: space-between;
                 padding: 16px 0 12px; border-bottom: 1px solid var(--border);
                 margin-bottom: 4px; position: sticky; top: 0; background: var(--bg); z-index: 1; }
  .edit-header-title { font-size: 16px; font-weight: 700; }
  .edit-cancel-btn { padding: 6px 12px; border-radius: 10px; border: 1px solid var(--border);
                     background: transparent; color: var(--text-dim); font-size: 13px; cursor: pointer; }
  .edit-save-btn   { padding: 6px 14px; border-radius: 10px; border: none;
                     background: var(--purple); color: white; font-size: 13px;
                     font-weight: 700; cursor: pointer; }

  /* â”€â”€ Loading skeletons â”€â”€ */
  .skeleton-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px;
                   padding: 13px 14px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
  .sk-icon  { width: 36px; height: 36px; border-radius: 10px; background: var(--card2); flex-shrink: 0;
              animation: shimmer 1.2s ease-in-out infinite; }
  .sk-lines { flex: 1; }
  .sk-line  { height: 10px; border-radius: 6px; background: var(--card2);
              animation: shimmer 1.2s ease-in-out infinite; margin-bottom: 7px; }
  .sk-line.short { width: 55%; margin-bottom: 0; }
  @keyframes shimmer { 0%,100%{opacity:0.4} 50%{opacity:0.9} }

  /* â”€â”€ Summary â”€â”€ */
  .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .summary-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
  .summary-card-label { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
  .summary-card-value { font-size: 20px; font-weight: 700; }
  .summary-card-value.out { color: var(--accent-out); }
  .summary-card-value.in  { color: var(--accent-in); }
  .summary-card-value.net.pos { color: var(--green); }
  .summary-card-value.net.neg { color: var(--accent-out); }
  .month-picker { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-top: 2px; }
  .month-nav { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border);
               background: var(--card); color: var(--text); font-size: 18px; cursor: pointer;
               display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .month-label { flex: 1; text-align: center; font-weight: 700; font-size: 15px; }
  .bar-chart { margin-bottom: 16px; }
  .bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .bar-row-label { font-size: 12px; color: var(--text-dim); width: 80px; flex-shrink: 0;
                   white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .bar-track { flex: 1; height: 18px; background: var(--card); border-radius: 6px; overflow: hidden; }
  .bar-fill  { height: 100%; border-radius: 6px; transition: width 0.4s ease; }
  .bar-fill.out { background: var(--accent-out); }
  .bar-fill.in  { background: var(--accent-in); }
  .bar-val { font-size: 12px; font-weight: 600; width: 70px; text-align: right; flex-shrink: 0; }
  .pdf-btn { width: 100%; padding: 14px; border-radius: 14px; border: 1px solid var(--purple);
             background: rgba(192,132,252,0.1); color: var(--purple); font-size: 14px;
             font-weight: 700; cursor: pointer; margin-top: 8px; }

  /* â”€â”€ Modals â”€â”€ */
  .img-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.93);
               z-index: 200; align-items: center; justify-content: center; padding: 20px; }
  .img-modal.show { display: flex; }
  .img-modal img { max-width: 100%; max-height: 90vh; border-radius: 12px; object-fit: contain; }
  .modal-close { position: fixed; top: 18px; right: 18px; width: 38px; height: 38px;
                 border-radius: 50%; background: rgba(255,255,255,0.15); border: none;
                 color: white; font-size: 18px; cursor: pointer;
                 display: flex; align-items: center; justify-content: center; }
  .setup-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
                 z-index: 300; align-items: flex-start; justify-content: center;
                 padding: 20px; overflow-y: auto; }
  .setup-modal.show { display: flex; }
  .setup-box { background: var(--card); border: 1px solid var(--border); border-radius: 20px;
               padding: 24px; max-width: 460px; width: 100%; margin-top: 20px; }
  .setup-box h2 { font-size: 18px; margin-bottom: 4px; }
  .setup-box p  { font-size: 13px; color: var(--text-dim); margin-bottom: 14px; }
  .setup-box input { width: 100%; background: var(--bg); border: 1px solid var(--border);
                     border-radius: 12px; padding: 12px 14px; font-size: 13px; color: var(--text);
                     outline: none; margin-bottom: 10px; font-family: monospace; }
  .setup-box input:focus { border-color: var(--purple); }
  .setup-save-btn { width: 100%; padding: 14px; border-radius: 14px; border: none;
                    background: var(--purple); color: white; font-size: 15px;
                    font-weight: 700; cursor: pointer; margin-top: 4px; }

  /* â”€â”€ Empty / Toast â”€â”€ */
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); }
  .empty-state .emoji { font-size: 36px; margin-bottom: 10px; }
  .toast { position: fixed;
           bottom: calc(var(--tab-h) + env(safe-area-inset-bottom, 0px) + 12px);
           left: 50%; transform: translateX(-50%) translateY(70px);
           background: var(--green); color: #000; padding: 11px 22px; border-radius: 24px;
           font-weight: 700; font-size: 13px; transition: transform 0.3s ease, opacity 0.3s ease;
           z-index: 100; white-space: nowrap; opacity: 0; pointer-events: none; }
  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

  @media print {
    .pin-screen, .header, .tab-bar, .pdf-btn, .month-nav, .refresh-btn { display: none !important; }
    .app-wrap.visible { display: block !important; }
    .content { padding-bottom: 16px; }
    body { background: white; color: black; }
    .summary-card { border: 1px solid #ddd; }
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PIN LOCK SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="pin-screen" id="pinScreen">
  <div class="pin-logo">ğŸ”’</div>
  <div class="pin-title" id="pinTitle">Welcome back</div>
  <div class="pin-sub"  id="pinSub">Enter your PIN to unlock</div>
  <div class="pin-step" id="pinStep" style="display:none">Step 1 of 2 â€” Set PIN</div>

  <div class="pin-dots" id="pinDots">
    <div class="pin-dot" id="d0"></div>
    <div class="pin-dot" id="d1"></div>
    <div class="pin-dot" id="d2"></div>
    <div class="pin-dot" id="d3"></div>
  </div>

  <div class="pin-error" id="pinError"></div>

  <div class="pin-keypad">
    <button class="pin-key" onclick="pinKey('1')">1</button>
    <button class="pin-key" onclick="pinKey('2')">2<div class="pin-key-sub">ABC</div></button>
    <button class="pin-key" onclick="pinKey('3')">3<div class="pin-key-sub">DEF</div></button>
    <button class="pin-key" onclick="pinKey('4')">4<div class="pin-key-sub">GHI</div></button>
    <button class="pin-key" onclick="pinKey('5')">5<div class="pin-key-sub">JKL</div></button>
    <button class="pin-key" onclick="pinKey('6')">6<div class="pin-key-sub">MNO</div></button>
    <button class="pin-key" onclick="pinKey('7')">7<div class="pin-key-sub">PQRS</div></button>
    <button class="pin-key" onclick="pinKey('8')">8<div class="pin-key-sub">TUV</div></button>
    <button class="pin-key" onclick="pinKey('9')">9<div class="pin-key-sub">WXYZ</div></button>
    <button class="pin-key empty"></button>
    <button class="pin-key" onclick="pinKey('0')">0</button>
    <button class="pin-key del" onclick="pinDel()">âŒ«</button>
  </div>

  <div class="pin-change-link" id="pinChangeLink" onclick="startChangePIN()" style="display:none">
    Change PIN
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-wrap" id="appWrap">

  <div class="header">
    <div>
      <div class="header-title">ğŸ’° Money Tracker</div>
      <div class="header-date" id="headerDate"></div>
    </div>
    <button class="setup-btn" onclick="openSetup()">âš™ï¸ Setup</button>
  </div>

  <div class="content">

    <!-- â•â• ADD â•â• -->
    <div class="page active" id="page-add">
      <div class="sync-bar">
        <div class="sync-dot" id="syncDot"></div>
        <span id="syncStatus">Not connected to Google Sheets</span>
      </div>
      <div class="inout-toggle">
        <button class="inout-btn out" id="btn-out" onclick="setDirection('out')">ğŸ’¸ Spent</button>
        <button class="inout-btn in"  id="btn-in"  onclick="setDirection('in')">ğŸ’° Received</button>
      </div>
      <div class="amount-row">
        <div class="yen-badge">Â¥</div>
        <input class="amount-input" id="amountInput" type="number" inputmode="decimal" placeholder="0" min="0">
      </div>
      <div class="section-label">Method</div>
      <div class="chip-grid" id="method-chips"></div>
      <!-- Card sub-selector (shown only when Credit Card is selected) -->
      <div class="card-field" id="cardField">
        <div class="section-label">Which card? ğŸ’³</div>
        <div class="chip-grid" id="card-chips"></div>
      </div>
      <div class="section-label">Situation</div>
      <div class="chip-grid" id="situation-chips"></div>
      <div class="who-field" id="whoField">
        <div class="section-label">With who?</div>
        <input class="text-input" id="whoInput" type="text" placeholder="Nameâ€¦">
      </div>
      <div class="section-label">Description <span style="opacity:0.4">(optional)</span></div>
      <input class="text-input" id="descInput" type="text" placeholder="e.g. lunch ramen, Starbucksâ€¦" maxlength="60">
      <div id="receiptSection">
        <div class="section-label">Receipt photo <span style="opacity:0.4">(optional)</span></div>
        <div class="receipt-btns">
          <label class="receipt-upload-btn" for="receiptCamera">
            ğŸ“·<br>Take Photo
            <input type="file" id="receiptCamera" accept="image/*" capture="environment" style="display:none" onchange="handleReceiptFile(this)">
          </label>
          <label class="receipt-upload-btn" for="receiptGallery">
            ğŸ–¼ï¸<br>Choose Image
            <input type="file" id="receiptGallery" accept="image/*" style="display:none" onchange="handleReceiptFile(this)">
          </label>
        </div>
        <div class="receipt-preview-wrap" id="receiptPreviewWrap">
          <img class="receipt-preview" id="receiptPreviewImg" src="" alt="receipt" onclick="openImgModal(this.src)">
          <button class="receipt-remove-btn" onclick="removeReceipt()">âœ•</button>
        </div>
      </div>
      <div class="section-label">Date &amp; Time</div>
      <div class="date-row">
        <span class="date-label">ğŸ“…</span>
        <input class="date-input-styled" type="date" id="dateInput" onchange="updateDate()">
      </div>
      <div class="date-row" style="margin-top:8px">
        <span class="date-label">ğŸ•</span>
        <input class="date-input-styled" type="time" id="timeInput" onchange="updateTime()">
      </div>
      <button class="save-btn" onclick="saveEntry()">âœ“ Save</button>
    </div>

    <!-- â•â• LOG â•â• -->
    <div class="page" id="page-log">
      <div class="log-header">
        <div class="log-header-label">Recent Entries</div>
        <button class="refresh-btn" id="refreshBtn" onclick="fetchFromSheets(true)">
          <span id="refreshIcon">â†»</span> Sync
        </button>
      </div>
      <div id="entriesList"></div>
      <div id="sheetLinkBar" style="display:none;text-align:center;padding:14px 0 20px">
        <a id="sheetLinkBtn" href="#" target="_blank" rel="noopener"
          style="display:inline-flex;align-items:center;gap:7px;padding:10px 20px;
                 background:var(--card);border:1px solid var(--border);border-radius:14px;
                 color:var(--text-dim);font-size:13px;text-decoration:none;">
          ğŸ“Š Open Google Sheets
        </a>
      </div>
    </div>

    <!-- â•â• SUMMARY â•â• -->
    <div class="page" id="page-summary">
      <div class="month-picker">
        <button class="month-nav" onclick="changeMonth(-1)">â€¹</button>
        <div class="month-label" id="summaryMonthLabel"></div>
        <button class="month-nav" onclick="changeMonth(1)">â€º</button>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-card-label">ğŸ’¸ Total Spent</div>
          <div class="summary-card-value out" id="sumSpent">Â¥0</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-label">ğŸ’° Total Received</div>
          <div class="summary-card-value in" id="sumReceived">Â¥0</div>
        </div>
        <div class="summary-card" style="grid-column:span 2">
          <div class="summary-card-label">ğŸ“ˆ Net Balance</div>
          <div class="summary-card-value net" id="sumNet">Â¥0</div>
        </div>
      </div>
      <div class="section-label" style="margin-top:0">Spending by Situation</div>
      <div class="bar-chart" id="situationChart"></div>
      <div class="section-label">Spending by Method</div>
      <div class="bar-chart" id="methodChart"></div>
      <button class="pdf-btn" onclick="printSummary()">ğŸ–¨ Print / Save as PDF</button>
    </div>

  </div><!-- /content -->

  <!-- Bottom Tab Bar -->
  <div class="tab-bar">
    <button class="tab-btn active" id="tab-add" onclick="switchTab('add')">
      <span class="tab-icon">â•</span><span>Add</span>
    </button>
    <button class="tab-btn" id="tab-log" onclick="switchTab('log')">
      <span class="tab-icon">ğŸ“‹</span><span>Log</span>
    </button>
    <button class="tab-btn" id="tab-summary" onclick="switchTab('summary')">
      <span class="tab-icon">ğŸ“Š</span><span>Summary</span>
    </button>
  </div>

</div><!-- /app-wrap -->

<!-- Edit modal -->
<div class="edit-modal" id="editModal">
  <div class="edit-sheet">
    <div class="edit-header">
      <button class="edit-cancel-btn" onclick="closeEdit()">Cancel</button>
      <span class="edit-header-title">âœï¸ Edit Entry</span>
      <button class="edit-save-btn"   onclick="saveEdit()">Save</button>
    </div>

    <!-- Direction -->
    <div class="section-label">Type</div>
    <div class="inout-toggle" style="margin-bottom:12px">
      <button class="inout-btn out" id="edit-btn-out" onclick="setEditDirection('out')">ğŸ’¸ Spent</button>
      <button class="inout-btn in"  id="edit-btn-in"  onclick="setEditDirection('in')">ğŸ’° Received</button>
    </div>

    <!-- Amount -->
    <div class="section-label">Amount</div>
    <div class="amount-row">
      <div class="yen-badge">Â¥</div>
      <input class="amount-input" id="editAmount" type="number" inputmode="decimal" placeholder="0" min="0">
    </div>

    <!-- Method -->
    <div class="section-label">Method</div>
    <div class="chip-grid" id="edit-method-chips"></div>
    <!-- Card sub-selector -->
    <div class="card-field" id="editCardField">
      <div class="section-label">Which card? ğŸ’³</div>
      <div class="chip-grid" id="edit-card-chips"></div>
    </div>

    <!-- Situation -->
    <div class="section-label">Situation</div>
    <div class="chip-grid" id="edit-situation-chips"></div>

    <!-- Who -->
    <div class="who-field" id="editWhoField">
      <div class="section-label">With who?</div>
      <input class="text-input" id="editWho" type="text" placeholder="Nameâ€¦">
    </div>

    <!-- Description -->
    <div class="section-label">Description <span style="opacity:0.4">(optional)</span></div>
    <input class="text-input" id="editDesc" type="text" placeholder="e.g. lunch ramenâ€¦" maxlength="60">

    <!-- Date & Time -->
    <div class="section-label">Date &amp; Time</div>
    <div class="date-row">
      <span class="date-label">ğŸ“…</span>
      <input class="date-input-styled" type="date" id="editDate">
    </div>
    <div class="date-row" style="margin-top:8px;margin-bottom:8px">
      <span class="date-label">ğŸ•</span>
      <input class="date-input-styled" type="time" id="editTime">
    </div>
  </div>
</div>

<!-- Image modal -->
<div class="img-modal" id="imgModal" onclick="closeImgModal()">
  <button class="modal-close">âœ•</button>
  <img id="imgModalSrc" src="" alt="receipt">
</div>

<!-- Setup modal -->
<div class="setup-modal" id="setupModal">
  <div class="setup-box">
    <h2>âš™ï¸ Connect Google Sheets</h2>
    <p>Paste your Google Apps Script Web App URL below to sync data to your spreadsheet.</p>
    <input type="url" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/â€¦/exec">
    <p style="margin-top:8px">Don't have one yet? Open the <strong>SETUP GUIDE</strong> file for step-by-step instructions.</p>
    <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
    <p style="margin-bottom:8px;font-size:13px">ğŸ“Š Google Sheet URL <span style="color:var(--text-dim)">(optional â€” for direct link)</span></p>
    <input type="url" id="sheetUrlInput" placeholder="https://docs.google.com/spreadsheets/d/â€¦/edit">
    <button class="setup-save-btn" onclick="saveScriptUrl()">Save & Connect</button>
    <button style="width:100%;margin-top:8px;padding:12px;border-radius:14px;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-size:13px" onclick="closeSetup()">Cancel</button>
    <hr style="border:none;border-top:1px solid var(--border);margin:18px 0">
    <p style="margin-bottom:8px">ğŸ” Change your lock PIN:</p>
    <button style="width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:transparent;color:var(--purple);cursor:pointer;font-size:13px;font-weight:600" onclick="closeSetup();startChangePIN()">Change PIN</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIN LOCK LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PIN_KEY     = 'mt_pin';       // stored in localStorage
const AUTH_KEY    = 'mt_authed';    // stored in sessionStorage (cleared on browser close)
const PIN_LENGTH  = 4;

let pinMode    = 'unlock';   // 'unlock' | 'setup' | 'change-old' | 'change-new' | 'change-confirm'
let pinBuffer  = '';         // digits entered so far
let pinPending = '';         // for confirm step (stores first entry)

function initPIN() {
  const savedPIN = localStorage.getItem(PIN_KEY);
  const authed   = sessionStorage.getItem(AUTH_KEY);

  if (!savedPIN) {
    // First ever open â€” let user set a PIN
    enterMode('setup');
  } else if (authed === '1') {
    // Already authenticated this session
    unlockApp();
  } else {
    // Has PIN but not authenticated yet
    enterMode('unlock');
  }
}

function enterMode(mode) {
  pinMode   = mode;
  pinBuffer = '';
  pinPending = '';
  updateDots();
  clearPinError();

  const title    = document.getElementById('pinTitle');
  const sub      = document.getElementById('pinSub');
  const stepBadge= document.getElementById('pinStep');
  const changeLnk= document.getElementById('pinChangeLink');

  if (mode === 'setup') {
    document.querySelector('.pin-logo').textContent = 'ğŸŒ¸';
    title.textContent = 'Create your PIN';
    sub.textContent   = 'Choose a 4-digit PIN to protect your tracker.';
    stepBadge.textContent = 'Step 1 of 2 â€” Set PIN';
    stepBadge.style.display = 'inline-block';
    changeLnk.style.display = 'none';
  } else if (mode === 'setup-confirm') {
    title.textContent = 'Confirm PIN';
    sub.textContent   = 'Enter the same PIN again to confirm.';
    stepBadge.textContent = 'Step 2 of 2 â€” Confirm PIN';
    stepBadge.style.display = 'inline-block';
    changeLnk.style.display = 'none';
  } else if (mode === 'unlock') {
    document.querySelector('.pin-logo').textContent = 'ğŸ”’';
    title.textContent = 'Welcome back';
    sub.textContent   = 'Enter your PIN to unlock Money Tracker.';
    stepBadge.style.display = 'none';
    changeLnk.style.display = 'inline-block';
  } else if (mode === 'change-old') {
    document.querySelector('.pin-logo').textContent = 'ğŸ”';
    title.textContent = 'Change PIN';
    sub.textContent   = 'Enter your current PIN first.';
    stepBadge.style.display = 'none';
    changeLnk.style.display = 'none';
  } else if (mode === 'change-new') {
    title.textContent = 'New PIN';
    sub.textContent   = 'Choose a new 4-digit PIN.';
    stepBadge.textContent = 'Step 1 of 2 â€” New PIN';
    stepBadge.style.display = 'inline-block';
    changeLnk.style.display = 'none';
  } else if (mode === 'change-confirm') {
    title.textContent = 'Confirm new PIN';
    sub.textContent   = 'Enter the new PIN once more.';
    stepBadge.textContent = 'Step 2 of 2 â€” Confirm';
    stepBadge.style.display = 'inline-block';
    changeLnk.style.display = 'none';
  }
}

function pinKey(digit) {
  if (pinBuffer.length >= PIN_LENGTH) return;
  pinBuffer += digit;
  updateDots();
  if (pinBuffer.length === PIN_LENGTH) {
    setTimeout(handlePINComplete, 120); // tiny delay so last dot shows
  }
}

function pinDel() {
  if (!pinBuffer.length) return;
  pinBuffer = pinBuffer.slice(0, -1);
  updateDots();
  clearPinError();
}

function updateDots() {
  for (let i = 0; i < PIN_LENGTH; i++) {
    const dot = document.getElementById('d' + i);
    dot.classList.toggle('filled', i < pinBuffer.length);
    dot.classList.remove('error');
  }
}

function handlePINComplete() {
  if (pinMode === 'unlock') {
    const saved = localStorage.getItem(PIN_KEY);
    if (pinBuffer === saved) {
      sessionStorage.setItem(AUTH_KEY, '1');
      unlockApp();
    } else {
      pinError('Wrong PIN â€” try again');
    }

  } else if (pinMode === 'setup') {
    const _saved = pinBuffer;   // save BEFORE enterMode resets pinPending
    enterMode('setup-confirm');
    pinPending = _saved;

  } else if (pinMode === 'setup-confirm') {
    if (pinBuffer === pinPending) {
      localStorage.setItem(PIN_KEY, pinBuffer);
      sessionStorage.setItem(AUTH_KEY, '1');
      unlockApp();
      showToast('PIN set! ğŸ”’','#7fff7f');
    } else {
      pinError('PINs don\'t match â€” try again');
      setTimeout(() => enterMode('setup'), 900);
    }

  } else if (pinMode === 'change-old') {
    const saved = localStorage.getItem(PIN_KEY);
    if (pinBuffer === saved) {
      enterMode('change-new');
    } else {
      pinError('Wrong PIN');
    }

  } else if (pinMode === 'change-new') {
    const _saved = pinBuffer;   // save BEFORE enterMode resets pinPending
    enterMode('change-confirm');
    pinPending = _saved;

  } else if (pinMode === 'change-confirm') {
    if (pinBuffer === pinPending) {
      localStorage.setItem(PIN_KEY, pinBuffer);
      // Go back to app
      document.getElementById('pinScreen').classList.add('hidden');
      showToast('PIN changed! ğŸ”’','#7fff7f');
    } else {
      pinError('PINs don\'t match');
      setTimeout(() => enterMode('change-new'), 900);
    }
  }
}

function pinError(msg) {
  document.getElementById('pinError').textContent = msg;
  for (let i = 0; i < PIN_LENGTH; i++) {
    document.getElementById('d' + i).classList.add('error');
  }
  document.getElementById('pinDots').classList.add('shake');
  setTimeout(() => {
    document.getElementById('pinDots').classList.remove('shake');
    pinBuffer = '';
    updateDots();
  }, 450);
}

function clearPinError() {
  document.getElementById('pinError').textContent = '';
}

function unlockApp() {
  const ps = document.getElementById('pinScreen');
  ps.classList.add('hidden');
  setTimeout(() => { ps.style.display = 'none'; }, 380);
  document.getElementById('appWrap').classList.add('visible');
  initApp();
}

function startChangePIN() {
  // Show the PIN screen in change-old mode (on top of the app)
  const ps = document.getElementById('pinScreen');
  ps.style.display = 'flex';
  ps.classList.remove('hidden');
  enterMode('change-old');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP STATE & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = { direction: null, method: null, situation: null, card: null, receiptImage: null, date: todayStr(), time: nowTimeStr() };
let entries    = JSON.parse(localStorage.getItem('mt_entries') || '[]');
let scriptUrl  = localStorage.getItem('mt_scriptUrl') || '';
let sheetUrl   = localStorage.getItem('mt_sheetUrl')  || '';
let summaryMonth = new Date();
let fetching   = false;
let editState  = { id: null, direction: 'out', method: null, situation: null, card: null };

const METHODS_OUT    = ['ğŸ’µ Cash','ğŸ“± PayPay','ğŸšƒ PASMO','ğŸ’³ Credit Card','â“ Other'];
const METHODS_IN     = ['ğŸ’µ Cash','ğŸ“± PayPay','ğŸšƒ PASMO','ğŸ¦ Bank Transfer','â“ Other'];
const SITUATIONS_OUT = ['ğŸ›’ Real world','ğŸ“± App/Game','ğŸŒ Online shop','ğŸ¤ Lend to friend','â“ Other'];
const SITUATIONS_IN  = ['ğŸ¤ Got money back','ğŸ’¼ Income','ğŸ Tip / Bonus','ğŸ“¥ Borrowed from someone','â“ Other'];
const CREDIT_CARDS   = ['Rakuten','JCB ANA','JCB Gold','AMEX','Granblue','Dahsing'];

// â”€â”€ Init app (called after PIN unlock) â”€â”€
function initApp() {
  document.getElementById('headerDate').textContent =
    new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  document.getElementById('dateInput').value = todayStr();
  document.getElementById('timeInput').value = nowTimeStr();
  setDirection('out');
  updateSyncStatus();
  updateSheetLink();
  renderEntries();
  renderSummary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function todayStr() { return new Date().toISOString().split('T')[0]; }
function nowTimeStr() {
  const now = new Date();
  return now.toLocaleTimeString('en-CA', { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'Asia/Tokyo' });
}
function updateDate() { state.date = document.getElementById('dateInput').value; }
function updateTime() { state.time = document.getElementById('timeInput').value; }
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function normalizeDate(d) {
  if (!d) return todayStr();
  const s = String(d);
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  try { return new Date(s).toLocaleDateString('en-CA', {timeZone:'Asia/Tokyo'}); }
  catch(e) { return s.split('T')[0]; }
}
function normalizeISO(s) {
  if (!s) return new Date().toISOString();
  s = String(s);
  if (s.includes('Z') || /[+-]\d{2}:\d{2}$/.test(s)) return s;
  if (s.includes(' ')) return s.replace(' ','T') + '+09:00';
  if (s.includes('T')) return s + '+09:00';
  return s;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DIRECTION / CHIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setDirection(dir) {
  state.direction = dir; state.method = null; state.situation = null; state.card = null;
  document.getElementById('btn-out').classList.toggle('active', dir==='out');
  document.getElementById('btn-in').classList.toggle('active',  dir==='in');
  renderChips('method-chips',    dir==='out' ? METHODS_OUT    : METHODS_IN,    'method');
  renderChips('situation-chips', dir==='out' ? SITUATIONS_OUT : SITUATIONS_IN, 'situation');
  updateCardField();
  updateWhoField();
  document.getElementById('receiptSection').style.display = 'block'; // show for both in & out
}
function renderChips(containerId, items, key) {
  document.getElementById(containerId).innerHTML = items.map((item,i) => {
    const active = state[key] === item;
    return `<button class="chip${active?' active '+state.direction+'-mode':''}"
      onclick="selectChip('${key}',${i})">${item}</button>`;
  }).join('');
}
function selectChip(key, idx) {
  const list = key==='method'
    ? (state.direction==='out'?METHODS_OUT:METHODS_IN)
    : (state.direction==='out'?SITUATIONS_OUT:SITUATIONS_IN);
  state[key] = list[idx];
  renderChips(key==='method'?'method-chips':'situation-chips', list, key);
  if (key==='method')    updateCardField();
  if (key==='situation') updateWhoField();
}
function updateWhoField() {
  const show = state.situation &&
    ['Lend to friend','Got money back','Borrowed from someone'].some(s=>state.situation.includes(s));
  document.getElementById('whoField').classList.toggle('show', show);
}
function updateCardField() {
  const isCC = state.method && state.method.includes('Credit Card');
  if (!isCC) state.card = null;
  document.getElementById('cardField').classList.toggle('show', !!isCC);
  if (isCC) renderCardChips();
}
function renderCardChips() {
  document.getElementById('card-chips').innerHTML = CREDIT_CARDS.map((c, i) => {
    const active = state.card === c;
    return `<button class="chip${active?' active '+state.direction+'-mode':''}"
      onclick="selectCard(${i})">${c}</button>`;
  }).join('');
}
function selectCard(idx) {
  state.card = CREDIT_CARDS[idx];
  renderCardChips();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECEIPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleReceiptFile(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => compressImage(e.target.result, 900, 0.72, compressed => {
    state.receiptImage = compressed;
    document.getElementById('receiptPreviewImg').src = compressed;
    document.getElementById('receiptPreviewWrap').classList.add('show');
  });
  reader.readAsDataURL(file); input.value = '';
}
function compressImage(dataUrl, maxPx, quality, cb) {
  const img = new Image();
  img.onload = () => {
    const c = document.createElement('canvas');
    let w=img.width, h=img.height;
    if (w>maxPx||h>maxPx){if(w>h){h=Math.round(h*maxPx/w);w=maxPx;}else{w=Math.round(w*maxPx/h);h=maxPx;}}
    c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
    cb(c.toDataURL('image/jpeg',quality));
  };
  img.src = dataUrl;
}
function removeReceipt() {
  state.receiptImage = null;
  document.getElementById('receiptPreviewImg').src = '';
  document.getElementById('receiptPreviewWrap').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveEntry() {
  const amount = parseFloat(document.getElementById('amountInput').value);
  if (!amount||amount<=0) { showToast('Enter an amount âš ï¸','#ffcc44'); return; }
  if (!state.method)      { showToast('Pick a method âš ï¸','#ffcc44');   return; }
  if (!state.situation)   { showToast('Pick a situation âš ï¸','#ffcc44'); return; }

  // If Credit Card chosen, embed card name into method for Sheets display
  const methodFull = (state.method && state.method.includes('Credit Card') && state.card)
    ? state.method + ' â€” ' + state.card
    : state.method;

  const entry = {
    id: Date.now(), direction: state.direction, amount, currency:'JPY',
    method: methodFull, situation: state.situation,
    desc: document.getElementById('descInput').value.trim(),
    receiptImage: state.receiptImage,
    who:  document.getElementById('whoInput').value.trim(),
    date: state.date,
    savedAt: (state.date && state.time)
      ? `${state.date}T${state.time}:00+09:00`
      : new Date().toISOString()
  };
  entries.unshift(entry);
  localStorage.setItem('mt_entries', JSON.stringify(entries));

  if (scriptUrl) {
    setSyncStatus('loading','Syncingâ€¦');
    try {
      await fetch(scriptUrl, { method:'POST', body:JSON.stringify(entry),
        headers:{'Content-Type':'text/plain'}, mode:'no-cors' });
      setSyncStatus('ok','Synced to Google Sheets âœ“');
    } catch(e) { setSyncStatus('error','Sync failed â€” saved locally'); }
  }

  document.getElementById('amountInput').value = '';
  document.getElementById('descInput').value   = '';
  document.getElementById('whoInput').value    = '';
  state.method=null; state.situation=null; state.card=null; state.receiptImage=null;
  state.time = nowTimeStr();
  document.getElementById('timeInput').value = state.time;
  document.getElementById('receiptPreviewImg').src='';
  document.getElementById('receiptPreviewWrap').classList.remove('show');
  renderChips('method-chips',    state.direction==='out'?METHODS_OUT:METHODS_IN,       'method');
  renderChips('situation-chips', state.direction==='out'?SITUATIONS_OUT:SITUATIONS_IN, 'situation');
  updateCardField();
  updateWhoField();
  showToast('Saved! ğŸŒ¸','#7fff7f');
  setTimeout(()=>switchTab('log'), 700);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FETCH FROM SHEETS (cross-device sync)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchFromSheets(manual=false) {
  if (!scriptUrl || fetching) return;
  fetching = true;
  const btn  = document.getElementById('refreshBtn');
  const icon = document.getElementById('refreshIcon');
  if (btn)  btn.classList.add('loading');
  if (icon) icon.innerHTML = '<span class="spin">â†»</span>';

  const list = document.getElementById('entriesList');
  if (!entries.length) {
    list.innerHTML = [1,2,3].map(()=>`
      <div class="skeleton-card">
        <div class="sk-icon"></div>
        <div class="sk-lines"><div class="sk-line"></div><div class="sk-line short"></div></div>
      </div>`).join('');
  }

  try {
    const res  = await fetch(scriptUrl + '?t=' + Date.now(), { redirect:'follow' });
    const data = await res.json();
    if (data.entries && Array.isArray(data.entries)) {
      const imgMap = {};
      entries.forEach(e => { if (e.receiptImage) imgMap[String(e.id)] = e.receiptImage; });
      entries = data.entries.map(e => ({
        id:           e.id,
        direction:    e.direction  || 'out',
        amount:       Number(e.amount) || 0,
        currency:     'JPY',
        method:       e.method    || 'â“ Other',
        situation:    e.situation || 'â“ Other',
        desc:         e.desc      || '',
        who:          e.who       || '',
        date:         normalizeDate(e.date),
        savedAt:      normalizeISO(e.savedAt),
        driveLink:    e.driveLink || '',
        receiptImage: imgMap[String(e.id)] || null
      }));
      localStorage.setItem('mt_entries', JSON.stringify(entries));
      renderEntries();
      renderSummary();
      if (manual) showToast(`${entries.length} entries synced âœ“`,'#7fff7f');
    }
  } catch(err) {
    if (manual) showToast('Sync failed â€” showing local data','#ffcc44');
    renderEntries();
  } finally {
    fetching = false;
    if (btn)  btn.classList.remove('loading');
    if (icon) icon.textContent = 'â†»';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEntries() {
  const list = document.getElementById('entriesList');
  if (!entries.length) {
    list.innerHTML = `<div class="empty-state">
      <div class="emoji">ğŸŒ¸</div>
      <p>No entries yet.<br><span style="font-size:12px">Tap â• to add your first one!</span></p>
    </div>`; return;
  }
  list.innerHTML = entries.slice(0,60).map(e => {
    const icon    = e.direction==='out' ? 'ğŸ’¸' : 'ğŸ’°';
    const sign    = e.direction==='out' ? 'âˆ’' : '+';
    const label   = e.desc || (e.situation ? e.situation.replace(/^\S+\s/,'') : 'â€”');
    const dateStr = new Date(e.date+'T12:00:00').toLocaleDateString('en-US',
                     {month:'short',day:'numeric',timeZone:'Asia/Tokyo'});
    const savedAt = e.savedAt ? new Date(e.savedAt) : new Date(e.date+'T12:00:00');
    const timeStr = savedAt.toLocaleTimeString('en-US',
                     {hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Asia/Tokyo'});
    // method may be "ğŸ’³ Credit Card â€” Rakuten" â€” strip emoji prefix, keep card name
    const method  = e.method ? e.method.replace(/^\S+\s/,'') : '';
    let receiptEl = '';
    if (e.receiptImage) {
      receiptEl = `<img class="entry-receipt-thumb" src="${e.receiptImage}"
        onclick="openImgModal('${e.receiptImage.replace(/'/g,'')}')">`;
    } else if (e.driveLink) {
      receiptEl = `<a class="entry-receipt-link" href="${esc(e.driveLink)}"
        target="_blank" rel="noopener" title="View receipt in Drive">ğŸ–¼ï¸</a>`;
    }
    return `<div class="entry-card" id="card-${e.id}">
      <div class="entry-icon ${e.direction}">${icon}</div>
      <div class="entry-info">
        <div class="entry-desc">${esc(label)}</div>
        <div class="entry-meta">${esc(method)} Â· ${dateStr} ${timeStr}${e.who?' Â· '+esc(e.who):''}</div>
        <div class="confirm-row" id="confirm-${e.id}" style="display:none">
          <span style="font-size:12px;color:var(--accent-out)">Delete this entry?</span>
          <button class="confirm-yes" onclick="confirmDelete('${e.id}')">Yes, delete</button>
          <button class="confirm-no"  onclick="cancelDelete('${e.id}')">Cancel</button>
        </div>
      </div>
      ${receiptEl}
      <div class="entry-amount ${e.direction}">${sign}Â¥${Number(e.amount).toLocaleString()}</div>
      <button class="entry-edit-btn"   onclick="openEdit('${e.id}')"  title="Edit">âœï¸</button>
      <button class="entry-delete-btn" onclick="askDelete('${e.id}')" title="Delete">ğŸ—‘</button>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function askDelete(id) {
  document.querySelectorAll('.confirm-row').forEach(r=>r.style.display='none');
  document.querySelectorAll('.entry-card').forEach(c=>c.classList.remove('confirming'));
  const cr=document.getElementById('confirm-'+id), cd=document.getElementById('card-'+id);
  if (cr) cr.style.display='flex';
  if (cd) cd.classList.add('confirming');
}
function cancelDelete(id) {
  const cr=document.getElementById('confirm-'+id), cd=document.getElementById('card-'+id);
  if (cr) cr.style.display='none';
  if (cd) cd.classList.remove('confirming');
}
async function confirmDelete(id) {
  entries = entries.filter(e=>String(e.id)!==String(id));
  localStorage.setItem('mt_entries', JSON.stringify(entries));
  renderEntries();
  showToast('Deleted ğŸ—‘','#ffcc44');
  if (scriptUrl) {
    try {
      await fetch(scriptUrl, { method:'POST', body:JSON.stringify({action:'delete',id}),
        headers:{'Content-Type':'text/plain'}, mode:'no-cors' });
    } catch(e) { /* silent */ }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEdit(id) {
  const e = entries.find(e => String(e.id) === String(id));
  if (!e) return;

  // Parse card from method string (e.g. "ğŸ’³ Credit Card â€” Rakuten")
  let parsedMethod = e.method || null;
  let parsedCard   = null;
  if (parsedMethod && parsedMethod.includes(' â€” ')) {
    const parts = parsedMethod.split(' â€” ');
    parsedMethod = parts[0].trim();
    parsedCard   = parts[1].trim();
  }

  editState = { id: e.id, direction: e.direction, method: parsedMethod, situation: e.situation, card: parsedCard };

  document.getElementById('editAmount').value = e.amount;
  document.getElementById('editDesc').value   = e.desc || '';
  document.getElementById('editWho').value    = e.who  || '';
  document.getElementById('editDate').value   = e.date;
  // Pre-fill time from savedAt (convert to JST HH:MM)
  const _savedAtDate = e.savedAt ? new Date(normalizeISO(e.savedAt)) : null;
  document.getElementById('editTime').value = _savedAtDate
    ? _savedAtDate.toLocaleTimeString('en-CA', {hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'Asia/Tokyo'})
    : nowTimeStr();

  setEditDirection(e.direction);            // renders chips + sets active direction
  editState.method    = parsedMethod;       // re-apply after setEditDirection reset them
  editState.situation = e.situation;
  editState.card      = parsedCard;
  renderEditChips('edit-method-chips',    editState.direction==='out'?METHODS_OUT:METHODS_IN,       'method');
  renderEditChips('edit-situation-chips', editState.direction==='out'?SITUATIONS_OUT:SITUATIONS_IN, 'situation');
  updateEditCardField();
  updateEditWhoField();

  document.getElementById('editModal').classList.add('show');
}

function closeEdit() {
  document.getElementById('editModal').classList.remove('show');
}

function setEditDirection(dir) {
  editState.direction  = dir;
  editState.method     = null;
  editState.situation  = null;
  editState.card       = null;
  document.getElementById('edit-btn-out').classList.toggle('active', dir==='out');
  document.getElementById('edit-btn-in').classList.toggle('active',  dir==='in');
  renderEditChips('edit-method-chips',    dir==='out'?METHODS_OUT:METHODS_IN,       'method');
  renderEditChips('edit-situation-chips', dir==='out'?SITUATIONS_OUT:SITUATIONS_IN, 'situation');
  updateEditCardField();
  updateEditWhoField();
}

function renderEditChips(containerId, items, key) {
  document.getElementById(containerId).innerHTML = items.map((item, i) => {
    const active = editState[key] === item;
    return `<button class="chip${active?' active '+editState.direction+'-mode':''}"
      onclick="selectEditChip('${key}',${i})">${item}</button>`;
  }).join('');
}

function selectEditChip(key, idx) {
  const list = key==='method'
    ? (editState.direction==='out'?METHODS_OUT:METHODS_IN)
    : (editState.direction==='out'?SITUATIONS_OUT:SITUATIONS_IN);
  editState[key] = list[idx];
  renderEditChips(key==='method'?'edit-method-chips':'edit-situation-chips', list, key);
  if (key==='method')    updateEditCardField();
  if (key==='situation') updateEditWhoField();
}

function updateEditWhoField() {
  const show = editState.situation &&
    ['Lend to friend','Got money back','Borrowed from someone'].some(s=>editState.situation.includes(s));
  document.getElementById('editWhoField').classList.toggle('show', show);
}
function updateEditCardField() {
  const isCC = editState.method && editState.method.includes('Credit Card');
  if (!isCC) editState.card = null;
  document.getElementById('editCardField').classList.toggle('show', !!isCC);
  if (isCC) renderEditCardChips();
}
function renderEditCardChips() {
  document.getElementById('edit-card-chips').innerHTML = CREDIT_CARDS.map((c, i) => {
    const active = editState.card === c;
    return `<button class="chip${active?' active '+editState.direction+'-mode':''}"
      onclick="selectEditCard(${i})">${c}</button>`;
  }).join('');
}
function selectEditCard(idx) {
  editState.card = CREDIT_CARDS[idx];
  renderEditCardChips();
}

async function saveEdit() {
  const amount = parseFloat(document.getElementById('editAmount').value);
  if (!amount||amount<=0)      { showToast('Enter an amount âš ï¸','#ffcc44'); return; }
  if (!editState.method)       { showToast('Pick a method âš ï¸','#ffcc44');   return; }
  if (!editState.situation)    { showToast('Pick a situation âš ï¸','#ffcc44'); return; }

  const date     = document.getElementById('editDate').value;
  const editTime = document.getElementById('editTime').value;
  const desc     = document.getElementById('editDesc').value.trim();
  const who      = document.getElementById('editWho').value.trim();
  const newSavedAt = (date && editTime)
    ? `${date}T${editTime}:00+09:00`
    : entries[idx]?.savedAt || new Date().toISOString();

  // Update in local entries array
  const idx = entries.findIndex(e => String(e.id) === String(editState.id));
  if (idx === -1) { closeEdit(); return; }

  const editMethodFull = (editState.method && editState.method.includes('Credit Card') && editState.card)
    ? editState.method + ' â€” ' + editState.card
    : editState.method;

  entries[idx] = {
    ...entries[idx],
    direction: editState.direction,
    amount,
    method:    editMethodFull,
    situation: editState.situation,
    desc, who, date,
    savedAt:   newSavedAt
  };
  localStorage.setItem('mt_entries', JSON.stringify(entries));
  renderEntries();
  renderSummary();
  closeEdit();
  showToast('Updated! âœï¸','#7fff7f');

  // Sync update to Google Sheets
  if (scriptUrl) {
    try {
      await fetch(scriptUrl, {
        method: 'POST',
        body: JSON.stringify({ action:'update', id: editState.id,
          direction: editState.direction, amount, method: editMethodFull,
          situation: editState.situation, desc, who, date, savedAt: newSavedAt }),
        headers: {'Content-Type':'text/plain'}, mode:'no-cors'
      });
    } catch(e) { /* silent â€” local update succeeded */ }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSummary() {
  const y=summaryMonth.getFullYear(), m=summaryMonth.getMonth();
  document.getElementById('summaryMonthLabel').textContent =
    summaryMonth.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const monthE   = entries.filter(e=>{ const d=new Date(e.date+'T12:00:00'); return d.getFullYear()===y&&d.getMonth()===m; });
  const spent    = monthE.filter(e=>e.direction==='out').reduce((s,e)=>s+Number(e.amount),0);
  const received = monthE.filter(e=>e.direction==='in' ).reduce((s,e)=>s+Number(e.amount),0);
  const net      = received - spent;
  document.getElementById('sumSpent').textContent    = 'Â¥'+spent.toLocaleString();
  document.getElementById('sumReceived').textContent = 'Â¥'+received.toLocaleString();
  const netEl=document.getElementById('sumNet');
  netEl.textContent = (net>=0?'+':'')+'Â¥'+Math.abs(net).toLocaleString();
  netEl.className   = 'summary-card-value net '+(net>=0?'pos':'neg');
  const sitMap={}, methMap={};
  monthE.filter(e=>e.direction==='out').forEach(e=>{
    const sk=e.situation?e.situation.replace(/^\S+\s/,''):'Other';
    const mk=e.method?e.method.replace(/^\S+\s/,''):'Other';
    sitMap[sk]=(sitMap[sk]||0)+Number(e.amount);
    methMap[mk]=(methMap[mk]||0)+Number(e.amount);
  });
  renderBarChart('situationChart',sitMap, spent,'out');
  renderBarChart('methodChart',   methMap,spent,'out');
}
function renderBarChart(id,map,total,dir){
  const el=document.getElementById(id);
  const sorted=Object.entries(map).sort((a,b)=>b[1]-a[1]);
  if(!sorted.length){el.innerHTML='<div style="color:var(--text-dim);font-size:13px;padding:8px 0">No data</div>';return;}
  el.innerHTML=sorted.map(([label,val])=>{
    const pct=total>0?(val/total*100).toFixed(0):0;
    return `<div class="bar-row">
      <div class="bar-row-label">${esc(label)}</div>
      <div class="bar-track"><div class="bar-fill ${dir}" style="width:${pct}%"></div></div>
      <div class="bar-val">Â¥${Number(val).toLocaleString()}</div>
    </div>`;
  }).join('');
}
function changeMonth(delta){
  summaryMonth=new Date(summaryMonth.getFullYear(),summaryMonth.getMonth()+delta,1);
  renderSummary();
}
function printSummary(){ switchTab('summary'); setTimeout(()=>window.print(),200); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SYNC / SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSyncStatus(){
  if(scriptUrl) setSyncStatus('ok','Connected to Google Sheets âœ“');
  else          setSyncStatus('','Not connected â€” data saved locally');
}
function setSyncStatus(type,msg){
  const dot=document.getElementById('syncDot'), txt=document.getElementById('syncStatus');
  if(dot) dot.className='sync-dot'+(type?' '+type:'');
  if(txt) txt.textContent=msg;
}
function openSetup(){
  document.getElementById('scriptUrlInput').value=scriptUrl;
  document.getElementById('sheetUrlInput').value=sheetUrl;
  document.getElementById('setupModal').classList.add('show');
}
function closeSetup(){ document.getElementById('setupModal').classList.remove('show'); }
function saveScriptUrl(){
  const url=document.getElementById('scriptUrlInput').value.trim();
  const surl=document.getElementById('sheetUrlInput').value.trim();
  scriptUrl=url; localStorage.setItem('mt_scriptUrl',url);
  sheetUrl=surl; localStorage.setItem('mt_sheetUrl',surl);
  closeSetup(); updateSyncStatus(); updateSheetLink();
  showToast(url?'Connected! ğŸŒ¸':'Disconnected','#7fff7f');
}
function updateSheetLink(){
  const bar=document.getElementById('sheetLinkBar');
  const btn=document.getElementById('sheetLinkBtn');
  if(bar&&btn){
    bar.style.display=sheetUrl?'block':'none';
    btn.href=sheetUrl||'#';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMAGE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openImgModal(src){ document.getElementById('imgModalSrc').src=src; document.getElementById('imgModal').classList.add('show'); }
function closeImgModal()  { document.getElementById('imgModal').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg,color='#7fff7f'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.background=color;
  t.style.color=(color==='#ffcc44'||color==='#ff6b9d')?'#fff':'#000';
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  ['add','log','summary'].forEach(t=>{
    const b=document.getElementById('tab-'+t);
    if(b) b.classList.toggle('active',t===tab);
  });
  document.getElementById('page-'+tab).classList.add('active');
  if(tab==='log'){ renderEntries(); if(scriptUrl) fetchFromSheets(false); }
  if(tab==='summary') renderSummary();
}

// â”€â”€ Boot â”€â”€
initPIN();
</script>
</body>
</html>
